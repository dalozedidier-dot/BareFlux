name: run-all

on:
  workflow_dispatch:
  push:
    paths:
      - "run_modules.sh"
      - "tools/generate_synth_datasets.py"
      - ".github/workflows/run-all.yml"
  pull_request:
    paths:
      - "run_modules.sh"
      - "tools/generate_synth_datasets.py"
      - ".github/workflows/run-all.yml"

jobs:
  run-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout BareFlux
        uses: actions/checkout@v4

      - name: Checkout modules (bloc 4)
        run: |
          set -euo pipefail
          mkdir -p modules
          git clone --depth 1 https://github.com/dalozedidier-dot/RiftLens modules/RiftLens
          git clone --depth 1 https://github.com/dalozedidier-dot/NullTrace modules/NullTrace
          git clone --depth 1 https://github.com/dalozedidier-dot/VoidMark modules/VoidMark

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies (all modules)
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -r modules/RiftLens/requirements.txt
          pip install -r modules/NullTrace/requirements.txt

      - name: Run orchestrator
        run: |
          set -euo pipefail
          chmod +x run_modules.sh
          ./run_modules.sh --modules-dir modules --out _bareflux_out --strict

      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bareflux-orchestration-out
          path: |
            _bareflux_out/**
            _ci_out/datasets/**
