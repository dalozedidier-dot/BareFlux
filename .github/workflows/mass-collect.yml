name: mass-collect

on:
  workflow_dispatch:
    inputs:
      runs:
        description: "Nombre d'itérations (ex 100)"
        required: false
        default: "100"
      n:
        description: "Lignes par dataset synthétique"
        required: false
        default: "200"
      seed_base:
        description: "Base seed (seed = seed_base + i)"
        required: false
        default: "1000"
      thresholds:
        description: "Seuils corr-threshold (csv)"
        required: false
        default: "0.50,0.60,0.70,0.75,0.80"
      k:
        description: "Répétitions par seuil (collect_stable)"
        required: false
        default: "5"

concurrency:
  group: bloc4-mass-collect-${{ github.ref }}
  cancel-in-progress: true

jobs:
  mass:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout BareFlux
        uses: actions/checkout@v4

      - name: Checkout RiftLens
        uses: actions/checkout@v4
        with:
          repository: dalozedidier-dot/RiftLens
          path: modules/RiftLens

      - name: Checkout NullTrace
        uses: actions/checkout@v4
        with:
          repository: dalozedidier-dot/NullTrace
          path: modules/NullTrace

      - name: Checkout VoidMark
        uses: actions/checkout@v4
        with:
          repository: dalozedidier-dot/VoidMark
          path: modules/VoidMark

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Ensure .github/constraints.txt exists (generated if missing)
        run: |
          set -euo pipefail
          if [ -f .github/constraints.txt ]; then
            echo ".github/constraints.txt present"
            exit 0
          fi

          echo ".github/constraints.txt missing, generating template"
          mkdir -p .github
          cat > .github/constraints.txt << 'EOF'
          numpy==1.26.4
          pandas==2.2.2
          matplotlib==3.9.2
          networkx==3.3
          pillow==10.4.0
          scipy==1.13.1
          jsonschema==4.23.0
          pytest==8.3.3
          python-dateutil==2.9.0.post0
          pytz==2024.1
          tzdata==2024.1
          six==1.17.0
          packaging==24.1
          typing-extensions==4.12.2
          EOF

          echo "Generated .github/constraints.txt:"
          sed -n '1,200p' .github/constraints.txt

      - name: Install dependencies (pinned via .github/constraints.txt)
        run: |
          set -euo pipefail
          python -m pip install -U pip

          pip install -r requirements.txt -c .github/constraints.txt

          if [ -f requirements-dev.txt ] && [ -s requirements-dev.txt ]; then
            pip install -r requirements-dev.txt -c .github/constraints.txt
          else
            echo "requirements-dev.txt absent ou vide, skip"
          fi

          if [ -f modules/RiftLens/requirements.txt ] && [ -s modules/RiftLens/requirements.txt ]; then
            pip install -r modules/RiftLens/requirements.txt -c .github/constraints.txt
          else
            echo "modules/RiftLens/requirements.txt absent ou vide, skip"
          fi

          if [ -f modules/NullTrace/requirements.txt ] && [ -s modules/NullTrace/requirements.txt ]; then
            pip install -r modules/NullTrace/requirements.txt -c .github/constraints.txt
          else
            echo "modules/NullTrace/requirements.txt absent ou vide, skip"
          fi

      - name: Mass loop
        run: |
          set -euo pipefail
          RUNS="${{ github.event.inputs.runs }}"
          N="${{ github.event.inputs.n }}"
          SEED_BASE="${{ github.event.inputs.seed_base }}"
          THR="${{ github.event.inputs.thresholds }}"
          K="${{ github.event.inputs.k }}"

          mkdir -p _ci_out/mass
          echo "runs=${RUNS} n=${N} seed_base=${SEED_BASE} thresholds=${THR} k=${K}"

          for i in $(seq 1 "$RUNS"); do
            SEED=$((SEED_BASE + i))
            RUN_DIR="_ci_out/mass/run_${i}"
            mkdir -p "${RUN_DIR}/datasets" "${RUN_DIR}/stability"

            python tools/generate_synth_datasets.py --out-dir "${RUN_DIR}/datasets" --n "$N" --seed "$SEED"

            python tools/collect_stable.py               --thresholds "$THR"               --k "$K"               --datasets-dir "${{ github.workspace }}/${RUN_DIR}/datasets"               --out-dir "${{ github.workspace }}/${RUN_DIR}/stability"
          done

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bloc4-mass-collect
          path: _ci_out/mass/**
